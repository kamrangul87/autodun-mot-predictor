<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Autodun MOT Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      max-width: 480px;
      width: 100%;
      padding: 24px;
      margin: 24px 16px;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.6);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 20px;
    }

    .form-row {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #cbd5f5;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    button {
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #22c55e, #22d3ee);
      color: #020617;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity 0.15s ease, transform 0.1s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button:not(:disabled):active {
      transform: scale(0.97);
    }

    /* Main submit button full width */
    #submit-btn {
      width: 100%;
      margin-top: 8px;
    }

    .result-box {
      margin-top: 20px;
      padding: 12px 12px 16px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .result-headline {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .risk-meter-wrapper {
      margin-top: 12px;
      text-align: center;
    }

    .risk-meter-circle {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      margin: 0 auto;
      position: relative;
      background: conic-gradient(
        #22c55e 0deg,
        #22c55e 120deg,
        #eab308 120deg,
        #eab308 240deg,
        #ef4444 240deg,
        #ef4444 360deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .risk-meter-inner {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #e5e7eb;
    }

    .risk-score {
      font-size: 1.9rem;
      font-weight: 700;
    }

    .risk-label {
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .risk-bands {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      margin-top: 8px;
      color: #9ca3af;
    }

    .risk-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .risk-dot.low {
      background: #22c55e;
    }

    .risk-dot.med {
      background: #eab308;
    }

    .risk-dot.high {
      background: #ef4444;
    }

    .explanation {
      margin-top: 12px;
      font-size: 0.85rem;
      color: #d1d5db;
      line-height: 1.4;
    }

    .explanation strong {
      color: #e5e7eb;
    }

    .extra-factors {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .error {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #f97373;
    }

    /* Number plate lookup layout */
    .plate-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .plate-row input {
      flex: 1;
    }

    .plate-row button {
      white-space: nowrap;
      font-size: 0.85rem;
      padding: 9px 12px;
    }

    .lookup-status {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #9ca3af;
      min-height: 1em;
    }

    .lookup-status strong {
      color: #e5e7eb;
    }
  </style>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Autodun MOT Predictor</h1>
    <div class="subtitle">
      Estimate your MOT <strong>failure risk</strong> using age, mileage and history.
      More factors coming soon (service history, MOT data, etc.).
    </div>

    <form id="mot-form">
      <!-- Number plate lookup -->
      <div class="form-row">
        <label for="plate">Number plate (optional)</label>
        <div class="plate-row">
          <input
            id="plate"
            type="text"
            placeholder="e.g. AB12 CDE"
            autocomplete="off"
          />
          <button type="button" id="lookup-btn">Fetch MOT history</button>
        </div>
        <div id="lookup-status" class="lookup-status"></div>
      </div>

      <div class="form-row">
        <label for="vehicle_age">Vehicle age (years)</label>
        <input
          id="vehicle_age"
          type="number"
          min="0"
          step="0.1"
          placeholder="e.g. 7"
          required
        />
      </div>

      <div class="form-row">
        <label for="mileage">Current mileage</label>
        <input
          id="mileage"
          type="number"
          min="0"
          step="1"
          placeholder="e.g. 85000"
          required
        />
      </div>

      <div class="form-row">
        <label for="fuel_type">Fuel type</label>
        <select id="fuel_type">
          <option value="petrol">Petrol</option>
          <option value="diesel">Diesel</option>
          <option value="hybrid">Hybrid</option>
          <option value="electric">Electric</option>
        </select>
      </div>

      <div class="form-row">
        <label for="previous_fails">Previous MOT fails</label>
        <input
          id="previous_fails"
          type="number"
          min="0"
          step="1"
          placeholder="e.g. 0, 1, 2"
        />
      </div>

      <button id="submit-btn" type="submit">Predict MOT Risk</button>
    </form>

    <div id="result-container"></div>
    <div id="error-container" class="error"></div>
  </div>

  <script>
    const form = document.getElementById("mot-form");
    const resultContainer = document.getElementById("result-container");
    const errorContainer = document.getElementById("error-container");
    const submitBtn = document.getElementById("submit-btn");

    // Number plate lookup elements
    const plateInput = document.getElementById("plate");
    const lookupBtn = document.getElementById("lookup-btn");
    const lookupStatus = document.getElementById("lookup-status");

    function getBand(score) {
      if (score < 40) return "LOW";
      if (score < 70) return "MEDIUM";
      return "HIGH";
    }

    function getLabel(score) {
      if (score < 40) return "Low failure risk";
      if (score < 70) return "Moderate failure risk";
      return "High failure risk";
    }

    function buildExplanation(score, age, mileage, fuelType, previousFails) {
      const band = getBand(score);
      let baseText;

      if (band === "LOW") {
        baseText =
          "Based on your car being around " +
          age +
          " years old with " +
          mileage.toLocaleString() +
          " miles, the model thinks your MOT failure risk is relatively low. " +
          "Keep up regular servicing and basic checks (tyres, lights, brakes) before the test.";
      } else if (band === "MEDIUM") {
        baseText =
          "With a vehicle age of about " +
          age +
          " years and " +
          mileage.toLocaleString() +
          " miles, your risk sits in the middle. " +
          "It is a good idea to do a pre-MOT check: tyres, brake pads, suspension and warning lights.";
      } else {
        baseText =
          "Because your car is around " +
          age +
          " years old and has " +
          mileage.toLocaleString() +
          " miles, the model flags a higher chance of MOT failure. " +
          "Consider booking a service or addressing obvious issues (tyres below limit, dashboard warning lights, " +
          "brakes, exhaust and corrosion) before you go for the test.";
      }

      let extra = "";

      if (fuelType === "diesel") {
        extra +=
          " Diesel vehicles can be more sensitive on emissions during MOT, " +
          "so make sure there are no visible smoke issues and the engine is running smoothly. ";
      } else if (fuelType === "electric") {
        extra +=
          " Electric cars avoid some traditional MOT issues (emissions), " +
          "but tyres, suspension and brakes are still key check points. ";
      }

      if (previousFails > 0) {
        extra +=
          "Because this vehicle has previously failed MOT " +
          previousFails +
          " time(s), the model nudges risk upwards. Make sure previous advisories or fail points have been properly fixed.";
      }

      return baseText + " " + extra;
    }

    function normalizeVrm(input) {
      return (input || "").trim().replace(/\s+/g, "").toUpperCase();
    }

    function pickFuelSelectValue(dvsaFuelType) {
      const f = (dvsaFuelType || "").toLowerCase();
      if (f.includes("petrol")) return "petrol";
      if (f.includes("diesel")) return "diesel";
      if (f.includes("electric")) return "electric";
      if (f.includes("hybrid")) return "hybrid";
      return "";
    }

    // ✅ Number plate lookup handler (REAL DVSA via your backend GET /api/mot-history?vrm=)
    lookupBtn.addEventListener("click", async () => {
      const vrm = normalizeVrm(plateInput.value);
      lookupStatus.textContent = "";
      errorContainer.textContent = "";

      if (!vrm) {
        lookupStatus.textContent = "Please enter a number plate (e.g. AB12 CDE).";
        return;
      }

      lookupBtn.disabled = true;
      lookupStatus.textContent = "Fetching MOT history...";

      try {
        const res = await fetch(`/api/mot-history?vrm=${encodeURIComponent(vrm)}`, {
          method: "GET",
          headers: { Accept: "application/json" },
        });

        const data = await res.json().catch(() => null);

        if (!res.ok) {
          const msg =
            data?.dvsa_response?.errorMessage ||
            data?.message ||
            data?.error ||
            `Lookup failed (status ${res.status})`;
          throw new Error(msg);
        }

        if (!data || !data.registration || !Array.isArray(data.motTests)) {
          throw new Error("Invalid MOT data returned");
        }

        // Sort tests newest first (defensive)
        const tests = data.motTests
          .slice()
          .sort((a, b) => new Date(b.completedDate || 0) - new Date(a.completedDate || 0));

        const latest = tests[0] || null;

        // Age from firstUsedDate
        if (data.firstUsedDate) {
          const firstUsed = new Date(data.firstUsedDate);
          const ageYears = (Date.now() - firstUsed.getTime()) / (365.25 * 24 * 60 * 60 * 1000);
          document.getElementById("vehicle_age").value = Math.max(0, ageYears).toFixed(1);
        }

        // Mileage from latest odometerValue
        if (latest?.odometerValue != null) {
          const miles = Number(latest.odometerValue);
          if (!Number.isNaN(miles)) {
            document.getElementById("mileage").value = miles;
          }
        }

        // Previous fails count (FAILED results)
        const failCount = tests.filter((t) => t.testResult === "FAILED").length;
        document.getElementById("previous_fails").value = String(failCount);

        // Fuel type mapping
        const fuelValue = pickFuelSelectValue(data.fuelType);
        if (fuelValue) document.getElementById("fuel_type").value = fuelValue;

        // UI status line
        const make = data.make || "Unknown make";
        const model = data.model || "Unknown model";
        const expiry = latest?.expiryDate || "Unknown expiry";
        const lastMileage = latest?.odometerValue
          ? Number(latest.odometerValue).toLocaleString()
          : "n/a";

        lookupStatus.innerHTML =
          `DVSA MOT data: <strong>${make} ${model}</strong>` +
          ` · MOT expiry: <strong>${expiry}</strong>` +
          ` · Last mileage: <strong>${lastMileage}</strong>` +
          ` · Previous fails: <strong>${failCount}</strong>.`;
      } catch (err) {
        console.error(err);
        lookupStatus.textContent =
          `Could not fetch MOT history: ${err?.message || "Please try again."}`;
      } finally {
        lookupBtn.disabled = false;
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultContainer.innerHTML = "";
      errorContainer.textContent = "";
      submitBtn.disabled = true;

      const age = parseFloat(document.getElementById("vehicle_age").value);
      const mileage = parseFloat(document.getElementById("mileage").value);
      const fuelType = document.getElementById("fuel_type").value;
      const previousFailsRaw = document.getElementById("previous_fails").value;
      const previousFails = previousFailsRaw ? parseInt(previousFailsRaw, 10) : 0;

      if (isNaN(age) || isNaN(mileage)) {
        errorContainer.textContent = "Please enter valid numbers for age and mileage.";
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch("/api/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vehicle_age: age,
            mileage,
            fuel_type: fuelType,
            previous_fails: previousFails,
          }),
        });

        if (!res.ok) {
          throw new Error("Server error: " + res.status);
        }

        const data = await res.json();

        const explanationsRaw = Array.isArray(data.explanations) ? data.explanations : [];
        const explanationsTop = explanationsRaw.slice(0, 4);

        let score;
        if (typeof data.score === "number") {
          score = Math.max(0, Math.min(100, Math.round(data.score)));
        } else {
          const prediction = typeof data.prediction === "number" ? data.prediction : 0;
          score = Math.max(0, Math.min(100, Math.round(prediction * 100)));
        }

        const band = getBand(score);
        const label = getLabel(score);
        const explanation = buildExplanation(score, age, mileage, fuelType, previousFails);

        const fuelLabel = fuelType.charAt(0).toUpperCase() + fuelType.slice(1).toLowerCase();

        // Build "Why this score?" HTML from explanations
        let insightsHtml = "";
        if (explanationsTop.length > 0) {
          insightsHtml += `
            <div class="explanation" style="margin-top:8px;">
              <strong>Why this score?</strong><br />
              <ul style="margin:6px 0 0 18px; padding:0; list-style:disc; font-size:0.8rem;">
          `;

          explanationsTop.forEach((item) => {
            const labelText = item.label || item.feature_key || "This factor";
            const strength = item.strength || "small";
            const dirRaw = item.direction || "neutral";

            let dirText;
            if (dirRaw === "increase") dirText = "increases";
            else if (dirRaw === "decrease") dirText = "reduces";
            else dirText = "has little effect on";

            let strengthText;
            if (strength === "strong") strengthText = "strong impact";
            else if (strength === "moderate") strengthText = "moderate impact";
            else strengthText = "small impact";

            insightsHtml += `
              <li>
                <strong>${labelText}</strong> – ${dirText} the estimated failure risk
                (<span>${strengthText}</span>).
              </li>
            `;
          });

          insightsHtml += `
              </ul>
            </div>
          `;
        }

        resultContainer.innerHTML = `
          <div class="result-box">
            <div class="result-headline">
              Estimated MOT failure risk: ${score}% (${label})
            </div>
            <div class="result-subtitle">
              This is an early beta estimate based on UK-style MOT patterns. It is not official DVSA advice.
            </div>

            <div class="risk-meter-wrapper">
              <div class="risk-meter-circle">
                <div class="risk-meter-inner">
                  <div class="risk-score">${score}%</div>
                  <div class="risk-label">${band} RISK</div>
                </div>
              </div>

              <div class="risk-bands">
                <span><span class="risk-dot low"></span>0–39% Low</span>
                <span><span class="risk-dot med"></span>40–69% Medium</span>
                <span><span class="risk-dot high"></span>70–100% High</span>
              </div>
            </div>

            <div class="extra-factors">
              Fuel type: <strong>${fuelLabel}</strong>${
                previousFails > 0
                  ? ` · Previous MOT fails: <strong>${previousFails}</strong>`
                  : " · Previous MOT fails: <strong>None recorded</strong>"
              }
            </div>

            <div class="explanation">
              <strong>What this means for your MOT:</strong><br />
              ${explanation}
            </div>

            ${insightsHtml}

            <br />
            <button onclick="downloadPdf()"
              style="
                width: 100%;
                padding: 10px 14px;
                margin-top: 12px;
                border-radius: 999px;
                border: none;
                background: linear-gradient(to right, #3b82f6, #06b6d4);
                color: #020617;
                font-weight: 600;
                font-size: 1rem;
                cursor: pointer;
              ">
              Download MOT Report (PDF)
            </button>

            <button type="button" onclick="copyShareLink()"
              style="
                width: 100%;
                padding: 9px 14px;
                margin-top: 8px;
                border-radius: 999px;
                border: 1px solid #38bdf8;
                background: transparent;
                color: #e5e7eb;
                font-weight: 500;
                font-size: 0.95rem;
                cursor: pointer;
              ">
              Copy share link
            </button>
          </div>
        `;
      } catch (err) {
        console.error(err);
        errorContainer.textContent =
          "Something went wrong while predicting. Please try again in a moment.";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // PDF generator using jsPDF, reading from visible result box
    function downloadPdf() {
      const resultBox = document.querySelector(".result-box");
      if (!resultBox) {
        alert("Please run a prediction first.");
        return;
      }

      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("PDF library not loaded yet. Please try again.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "a4" });

      const now = new Date().toLocaleString();
      const plate = (document.getElementById("plate").value || "Not provided").toUpperCase();

      const age = document.getElementById("vehicle_age").value || "-";
      const mileage = document.getElementById("mileage").value || "-";
      const fuel = document.getElementById("fuel_type").value || "-";
      const prevFails = document.getElementById("previous_fails").value || "-";

      const resultText = resultBox.innerText;

      pdf.setFont("Helvetica", "normal");
      pdf.setFontSize(18);
      pdf.text("Autodun MOT Risk Report", 40, 50);

      pdf.setFontSize(11);
      pdf.text(`Generated: ${now}`, 40, 70);
      pdf.text(`Number Plate: ${plate}`, 40, 88);

      pdf.setFontSize(10);
      pdf.text(`Vehicle age (years): ${age}`, 40, 110);
      pdf.text(`Current mileage: ${mileage}`, 40, 126);
      pdf.text(`Fuel type: ${fuel}`, 40, 142);
      pdf.text(`Previous MOT fails: ${prevFails}`, 40, 158);

      pdf.setFontSize(11);
      pdf.text("Prediction details:", 40, 184);

      pdf.setFontSize(10);
      pdf.text(resultText, 40, 200, { maxWidth: 520 });

      pdf.save(`MOT_Report_${plate || "vehicle"}.pdf`);
    }

    // Copy deep link with current inputs
    function copyShareLink() {
      const url = new URL(window.location.href);

      const age = document.getElementById("vehicle_age").value;
      const mileage = document.getElementById("mileage").value;
      const fuel = document.getElementById("fuel_type").value;
      const prevFails = document.getElementById("previous_fails").value;
      const plate = document.getElementById("plate").value.trim();

      if (age) url.searchParams.set("age", age);
      if (mileage) url.searchParams.set("mileage", mileage);
      if (fuel) url.searchParams.set("fuel", fuel);
      if (prevFails) url.searchParams.set("fails", prevFails);
      if (plate) url.searchParams.set("plate", plate);

      const link = url.toString();

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(link)
          .then(() => {
            alert("Share link copied to clipboard.");
          })
          .catch(() => {
            alert("Could not copy automatically. Here is your link:\n" + link);
          });
      } else {
        // Fallback
        prompt("Copy this link:", link);
      }
    }

    // When opening a shared link, prefill form & auto-predict
    function initFromUrl() {
      try {
        const url = new URL(window.location.href);

        const age = url.searchParams.get("age");
        const mileage = url.searchParams.get("mileage");
        const fuel = url.searchParams.get("fuel");
        const fails = url.searchParams.get("fails");
        const plate = url.searchParams.get("plate");

        if (plate) document.getElementById("plate").value = plate;
        if (age) document.getElementById("vehicle_age").value = age;
        if (mileage) document.getElementById("mileage").value = mileage;
        if (fuel) document.getElementById("fuel_type").value = fuel;
        if (fails) document.getElementById("previous_fails").value = fails;

        if (age && mileage) {
          setTimeout(() => {
            form.dispatchEvent(new Event("submit"));
          }, 200);
        }
      } catch (err) {
        console.error("URL init failed", err);
      }
    }

    // Run on load
    initFromUrl();
  </script>
</body>
</html>
